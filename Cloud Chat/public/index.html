<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cloud Chat - General Room</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <button class="theme-toggle" id="themeToggle">
    <span class="theme-toggle-icon" id="themeIcon">☀</span>
    <span id="themeText">Light</span>
  </button>
  <div class="container">
    <div class="page-header">
      <h1>Cloud Chat</h1>
      <p class="text-muted">General Room</p>
    </div>

    <div id="chatArea" style="display:none;">
      <!-- Chat Messages -->
      <div id="chat"></div>

      <!-- Message Input -->
      <div class="message-input-container">
        <input id="message" type="text" placeholder="Type your message...">
        <button id="send">Send</button>
      </div>

      <!-- Main Controls -->
      <div class="controls">
        <button id="logout" class="btn-secondary">Logout</button>
      </div>

      <!-- Admin Controls -->
      <div id="adminControls" style="display:none;">
        <h4>⚙️ Admin Controls</h4>
        <div class="controls">
          <button id="deleteAll" class="btn-danger">Delete All Messages</button>
          <button id="goToAdmin">Chatroom Manager</button>
        </div>
      </div>

      <!-- Private Rooms List -->
      <div id="myRooms">
        <h3> Private Chatrooms</h3>
        <div id="roomsList">
          <p class="loading">Loading your rooms...</p>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, push, set, onChildAdded, remove, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD7lofjQ5AIFT6n-e1LpyployJxGdBChPE",
      authDomain: "cosc-3657.firebaseapp.com",
      databaseURL: "https://cosc-3657-default-rtdb.firebaseio.com",
      projectId: "cosc-3657",
      storageBucket: "cosc-3657.appspot.com",
      messagingSenderId: "899690413890",
      appId: "1:899690413890:web:2381f893e86abf3bc412db",
      measurementId: "G-JJC34GHJZL"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const chatRef = ref(db, "chatrooms/general/messages");

    onAuthStateChanged(auth, user => {
      if (user) {
        document.getElementById("chatArea").style.display = "block";
        const username = (user.displayName || user.email).toLowerCase();

        // Check user role
        get(ref(db, "roles/" + username)).then(roleSnap => {
          const role = roleSnap.exists() ? roleSnap.val() : "user";
          window.currentRole = role;

          console.log("User role:", role);

          // Show admin controls if user is admin
          if (role === "admin") {
            document.getElementById("adminControls").style.display = "block";

            // Admin button to navigate to admin page
            document.getElementById("goToAdmin").onclick = () => {
              window.location.href = "admin.html";
            };

            // Delete all messages button
            document.getElementById("deleteAll").onclick = () => {
              if (confirm("Are you sure you want to delete all messages?")) {
                remove(chatRef).then(() => {
                  alert("All messages deleted by admin");
                  document.getElementById("chat").innerHTML = "";
                }).catch(error => {
                  alert("Error deleting messages: " + error.message);
                });
              }
            };

            // Admins can see all rooms
            loadAllRooms(username);
          } else {
            // Regular users see only their rooms
            loadUserRooms(username);
          }

          // Listen for new messages
          onChildAdded(chatRef, snapshot => {
            const chatDiv = document.getElementById("chat");
            const msgData = snapshot.val();
            const msgId = snapshot.key;

            const msgElement = document.createElement("div");
            msgElement.className = "msg";
            msgElement.id = "msg-" + msgId;

            const msgContent = document.createElement("div");
            msgContent.className = "msg-content";
            msgContent.textContent = msgData.user + ": " + msgData.text;
            msgElement.appendChild(msgContent);

            // Add delete button for admins
            if (window.currentRole === "admin") {
              const delBtn = document.createElement("button");
              delBtn.className = "btn-small btn-danger";
              delBtn.textContent = "Delete";
              delBtn.onclick = () => {
                remove(ref(db, "chatrooms/general/messages/" + msgId)).then(() => {
                  const element = document.getElementById("msg-" + msgId);
                  if (element) element.remove();
                }).catch(error => {
                  alert("Error deleting message: " + error.message);
                });
              };
              msgElement.appendChild(delBtn);
            }

            chatDiv.appendChild(msgElement);
            chatDiv.scrollTop = chatDiv.scrollHeight;
          });
        }).catch(error => {
          console.error("Error fetching role:", error);
          alert("Error checking user role: " + error.message);
        });

        // Send messages
        document.getElementById("send").onclick = () => {
          const msg = document.getElementById("message").value;
          if (msg.trim() !== "") {
            const newMsgRef = push(chatRef);
            set(newMsgRef, {
              user: username,
              text: msg,
              timestamp: Date.now()
            }).then(() => {
              document.getElementById("message").value = "";
            }).catch(error => {
              alert("Error sending message: " + error.message);
            });
          }
        };

        // Allow Enter key to send message
        document.getElementById("message").onkeypress = (e) => {
          if (e.key === "Enter") {
            document.getElementById("send").click();
          }
        };

        // Logout
        document.getElementById("logout").onclick = () => {
          signOut(auth).then(() => {
            window.location.href = "login.html";
          });
        };
      } else {
        window.location.href = "login.html";
      }
    });

    // Load all rooms for admins
    function loadAllRooms(username) {
      const roomsListDiv = document.getElementById("roomsList");
      
      get(ref(db, "chatrooms")).then(snapshot => {
        if (snapshot.exists()) {
          const rooms = snapshot.val();
          let privateRoomCount = 0;
          roomsListDiv.innerHTML = "";

          Object.keys(rooms).forEach(roomName => {
            if (roomName !== "general") {
              const roomLink = document.createElement("div");
              roomLink.className = "room-link";
              roomLink.textContent = " ❇  " + roomName;
              roomLink.onclick = () => {
                window.location.href = "chatroom.html?room=" + roomName;
              };
              roomsListDiv.appendChild(roomLink);
              privateRoomCount++;
            }
          });

          if (privateRoomCount === 0) {
            roomsListDiv.innerHTML = '<p class="no-content">No private rooms yet.</p>';
          }
        } else {
          roomsListDiv.innerHTML = '<p class="no-content">No private rooms yet.</p>';
        }
      }).catch(error => {
        console.error("Error loading rooms:", error);
        roomsListDiv.innerHTML = '<p class="no-content">Error loading rooms.</p>';
      });
    }

    // Load user's rooms by checking membership
    function loadUserRooms(username) {
      const roomsListDiv = document.getElementById("roomsList");
      roomsListDiv.innerHTML = '<p class="loading">Checking your rooms...</p>';
      
      get(ref(db, "userMemberships/" + username)).then(snapshot => {
        if (snapshot.exists()) {
          const memberRooms = snapshot.val();
          roomsListDiv.innerHTML = "";
          let roomCount = 0;

          Object.keys(memberRooms).forEach(roomName => {
            if (memberRooms[roomName] === true) {
              const roomLink = document.createElement("div");
              roomLink.className = "room-link";
              roomLink.textContent = " ❇  " + roomName;
              roomLink.onclick = () => {
                window.location.href = "chatroom.html?room=" + roomName;
              };
              roomsListDiv.appendChild(roomLink);
              roomCount++;
            }
          });

          if (roomCount === 0) {
            roomsListDiv.innerHTML = '<p class="no-content">You are not a member of any private rooms yet.</p>';
          }
        } else {
          roomsListDiv.innerHTML = '<p class="no-content">You are not a member of any private rooms yet.</p>';
        }
      }).catch(error => {
        console.error("Error loading user rooms:", error);
        roomsListDiv.innerHTML = '<p class="no-content">Error loading your rooms.</p>';
      });
    }
  </script>
  <script>
  // Theme toggle functionality
  const themeToggle = document.getElementById('themeToggle');
  const themeIcon = document.getElementById('themeIcon');
  const themeText = document.getElementById('themeText');
  const htmlElement = document.documentElement;

  // Load saved theme or default to dark
  const currentTheme = localStorage.getItem('theme') || 'dark';
  htmlElement.setAttribute('data-theme', currentTheme);
  updateThemeUI(currentTheme);

  // Toggle theme on button click
  themeToggle.addEventListener('click', () => {
    const newTheme = htmlElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    htmlElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeUI(newTheme);
  });

  // Update UI elements
  function updateThemeUI(theme) {
    if (theme === 'light') {
      themeIcon.textContent = '☾';
      themeText.textContent = 'Dark';
    } else {
      themeIcon.textContent = '☀';
      themeText.textContent = 'Light';
    }
  }
</script>
</body>
</html>
