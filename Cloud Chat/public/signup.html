<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cloud Chat - Sign Up</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <button class="theme-toggle" id="themeToggle">
    <span class="theme-toggle-icon" id="themeIcon">☀</span>
    <span id="themeText">Light</span>
  </button>
  <div class="form-container">
    <div class="page-header">
      <h1>Cloud Chat</h1>
      <p class="text-muted">Create your account</p>
    </div>

    <div class="form-group">
      <label for="username">Username</label>
      <input id="username" type="text" placeholder="Choose a username">
    </div>

    <div class="form-group">
      <label for="email">Email</label>
      <input id="email" type="email" placeholder="Enter your email">
    </div>

    <div class="form-group">
      <label for="password">Password</label>
      <input id="password" type="password" placeholder="Create a password">
      <p class="form-info">Must be at least 8 characters with uppercase, lowercase, number, and special character (@$!%*?&)</p>
    </div>

    <button id="signup" class="btn" style="width: 100%;">Create Account</button>

    <div class="form-footer">
      <p>Already have an account? <a href="login.html">Login</a></p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD7lofjQ5AIFT6n-e1LpyployJxGdBChPE",
      authDomain: "cosc-3657.firebaseapp.com",
      databaseURL: "https://cosc-3657-default-rtdb.firebaseio.com",
      projectId: "cosc-3657",
      storageBucket: "cosc-3657.appspot.com",
      messagingSenderId: "899690413890",
      appId: "1:899690413890:web:2381f893e86abf3bc412db",
      measurementId: "G-JJC34GHJZL"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    document.getElementById("signup").onclick = () => {
      const username = document.getElementById("username").value.trim().toLowerCase();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;

      // Validate inputs
      if (!username || !email || !password) {
        alert("Please fill in all fields");
        return;
      }

      // Username validation
      if (username.length < 3) {
        alert("Username must be at least 3 characters long");
        return;
      }

      if (!/^[a-z0-9_]+$/.test(username)) {
        alert("Username can only contain lowercase letters, numbers, and underscores");
        return;
      }

      // Password strength check
      const strongPassword = /^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[@$!%*?&]).{8,}$/;
      if (!strongPassword.test(password)) {
        alert("Password must be at least 8 characters and include uppercase, lowercase, number, and special character (@$!%*?&)");
        return;
      }

      // Email validation
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        alert("Please enter a valid email address");
        return;
      }

      // Check if username already exists
      const usernameRef = ref(db, "usernames/" + username);
      get(usernameRef).then(snapshot => {
        if (snapshot.exists()) {
          alert("Username already taken. Please choose another.");
          return;
        }

        // Create user
        createUserWithEmailAndPassword(auth, email, password)
          .then(userCredential => {
            updateProfile(userCredential.user, { displayName: username })
              .then(() => {
                // Save both mappings in parallel
                Promise.all([
                  set(ref(db, "usernames/" + username), email),
                  set(ref(db, "roles/" + username), "user")
                ])
                .then(() => {
                  alert("Account created successfully! Please login.");
                  window.location.href = "login.html";
                })
                .catch(error => {
                  alert("Failed to save user data: " + error.message);
                });
              })
              .catch(error => {
                alert("Failed to set display name: " + error.message);
              });
          })
          .catch(error => {
            if (error.code === 'auth/email-already-in-use') {
              alert("Email already in use. Please use a different email or login.");
            } else if (error.code === 'auth/weak-password') {
              alert("Password is too weak. Please use a stronger password.");
            } else {
              alert("Error creating account: " + error.message);
            }
          });
      }).catch(error => {
        alert("Error checking username: " + error.message);
      });
    };

    // Allow Enter key to signup
    document.getElementById("password").onkeypress = (e) => {
      if (e.key === "Enter") {
        document.getElementById("signup").click();
      }
    };
  </script>
  <script>
  // Theme toggle functionality
  const themeToggle = document.getElementById('themeToggle');
  const themeIcon = document.getElementById('themeIcon');
  const themeText = document.getElementById('themeText');
  const htmlElement = document.documentElement;

  // Load saved theme or default to dark
  const currentTheme = localStorage.getItem('theme') || 'dark';
  htmlElement.setAttribute('data-theme', currentTheme);
  updateThemeUI(currentTheme);

  // Toggle theme on button click
  themeToggle.addEventListener('click', () => {
    const newTheme = htmlElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    htmlElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeUI(newTheme);
  });

  // Update UI elements
  function updateThemeUI(theme) {
    if (theme === 'light') {
      themeIcon.textContent = '☾';
      themeText.textContent = 'Dark';
    } else {
      themeIcon.textContent = '☀';
      themeText.textContent = 'Light';
    }
  }
</script>
</body>
</html>
