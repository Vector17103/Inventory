<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cloud Chat - Login</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <button class="theme-toggle" id="themeToggle">
    <span class="theme-toggle-icon" id="themeIcon">☀</span>
    <span id="themeText">Light</span>
  </button>
  <div class="form-container">
    <div class="page-header">
      <h1>Cloud Chat</h1>
      <p class="text-muted">Welcome back</p>
    </div>

    <div class="form-group">
      <label for="loginUsername">Username</label>
      <input id="loginUsername" type="text" placeholder="Enter your username">
    </div>

    <div class="form-group">
      <label for="loginPassword">Password</label>
      <input id="loginPassword" type="password" placeholder="Enter your password">
    </div>

    <button id="login" class="btn" style="width: 100%;">Login</button>

    <div class="form-footer">
      <p>New user? <a href="signup.html">Create an account</a></p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD7lofjQ5AIFT6n-e1LpyployJxGdBChPE",
      authDomain: "cosc-3657.firebaseapp.com",
      databaseURL: "https://cosc-3657-default-rtdb.firebaseio.com",
      projectId: "cosc-3657",
      storageBucket: "cosc-3657.appspot.com",
      messagingSenderId: "899690413890",
      appId: "1:899690413890:web:2381f893e86abf3bc412db",
      measurementId: "G-JJC34GHJZL"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    document.getElementById("login").onclick = () => {
      const username = document.getElementById("loginUsername").value.trim().toLowerCase();
      const password = document.getElementById("loginPassword").value;

      if (!username || !password) {
        alert("Please enter both username and password");
        return;
      }

      const usernameRef = ref(db, "usernames/" + username);
      get(usernameRef)
        .then(snapshot => {
          if (snapshot.exists()) {
            const email = snapshot.val();
            signInWithEmailAndPassword(auth, email, password)
              .then(() => {
                get(ref(db, "roles/" + username))
                  .then(roleSnap => {
                    const role = roleSnap.exists() ? roleSnap.val() : "user";
                    window.location.href = "index.html";
                  })
                  .catch(error => {
                    console.error("Error fetching role:", error);
                    window.location.href = "index.html";
                  });
              })
              .catch(error => {
                alert("Login failed: " + error.message);
              });
          } else {
            alert("Username not found");
          }
        })
        .catch(error => {
          alert("Error reading database: " + error.message);
        });
    };

    // Allow Enter key to login
    document.getElementById("loginPassword").onkeypress = (e) => {
      if (e.key === "Enter") {
        document.getElementById("login").click();
      }
    };
  </script>
  <script>
  // Theme toggle functionality
  const themeToggle = document.getElementById('themeToggle');
  const themeIcon = document.getElementById('themeIcon');
  const themeText = document.getElementById('themeText');
  const htmlElement = document.documentElement;

  // Load saved theme or default to dark
  const currentTheme = localStorage.getItem('theme') || 'dark';
  htmlElement.setAttribute('data-theme', currentTheme);
  updateThemeUI(currentTheme);

  // Toggle theme on button click
  themeToggle.addEventListener('click', () => {
    const newTheme = htmlElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    htmlElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeUI(newTheme);
  });

  // Update UI elements
  function updateThemeUI(theme) {
    if (theme === 'light') {
      themeIcon.textContent = '☾';
      themeText.textContent = 'Dark';
    } else {
      themeIcon.textContent = '☀';
      themeText.textContent = 'Light';
    }
  }
</script>
</body>
</html>
